<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Franklea&#39;s Base</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://franklea.github.io/"/>
  <updated>2018-04-16T02:38:26.365Z</updated>
  <id>http://franklea.github.io/</id>
  
  <author>
    <name>franklea</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>DNS学习与实践（二）—— dig简介</title>
    <link href="http://franklea.github.io/2018/04/16/dns-dig/"/>
    <id>http://franklea.github.io/2018/04/16/dns-dig/</id>
    <published>2018-04-16T02:38:26.000Z</published>
    <updated>2018-04-16T02:38:26.365Z</updated>
    
    <content type="html"><![CDATA[<p>Dig, domain information groper，是一款专门用于进行DNS查询的工具。 Dig以其灵活性，易用性，以及简明的输出得到了大多数DNS管理员的青睐。Dig支持命令行模式和批处理模式，批处理模式下，dig可以从文件中读取请求并批量处理。话不多说，进入正文。</p><p>通常，可使用如下命令使用dig:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig @server -t &lt;type&gt; &lt;name&gt; &lt;flag&gt;</span><br></pre></td></tr></table></figure></p><p>命令 “ <em>dig -h</em> ” 可显示dig的具体用法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">Usage:  dig [@global-server] [domain] [q-type] [q-class] &#123;q-opt&#125;</span><br><span class="line">            &#123;global-d-opt&#125; host [@local-server] &#123;local-d-opt&#125;</span><br><span class="line">            [ host [@local-server] &#123;local-d-opt&#125; [...]]</span><br><span class="line">Where:  domain  is in the Domain Name System</span><br><span class="line">        q-class  is one of (in,hs,ch,...) [default: in]</span><br><span class="line">        q-type   is one of (a,any,mx,ns,soa,hinfo,axfr,txt,...) [default:a]</span><br><span class="line">                 (Use ixfr=version for type ixfr)</span><br><span class="line">        q-opt    is one of:</span><br><span class="line">                 -4                  (use IPv4 query transport only)</span><br><span class="line">                 -6                  (use IPv6 query transport only)</span><br><span class="line">                 -b address[#port]   (bind to source address/port)</span><br><span class="line">                 -c class            (specify query class)</span><br><span class="line">                 -f filename         (batch mode)</span><br><span class="line">                 -i                  (use IP6.INT for IPv6 reverse lookups)</span><br><span class="line">                 -k keyfile          (specify tsig key file)</span><br><span class="line">                 -m                  (enable memory usage debugging)</span><br><span class="line">                 -p port             (specify port number)</span><br><span class="line">                 -q name             (specify query name)</span><br><span class="line">                 -t type             (specify query type)</span><br><span class="line">                 -u                  (display times in usec instead of msec)</span><br><span class="line">                 -x dot-notation     (shortcut for reverse lookups)</span><br><span class="line">                 -y [hmac:]name:key  (specify named base64 tsig key)</span><br><span class="line">        d-opt    is of the form +keyword[=value], where keyword is:</span><br><span class="line">                 +[no]aaonly         (Set AA flag in query (+[no]aaflag))</span><br><span class="line">                 +[no]additional     (Control display of additional section)</span><br><span class="line">                 +[no]adflag         (Set AD flag in query (default on))</span><br><span class="line">                 +[no]all            (Set or clear all display flags)</span><br><span class="line">                 +[no]answer         (Control display of answer section)</span><br><span class="line">                 +[no]authority      (Control display of authority section)</span><br><span class="line">                 +[no]besteffort     (Try to parse even illegal messages)</span><br><span class="line">                 +bufsize=###        (Set EDNS0 Max UDP packet size)</span><br><span class="line">                 +[no]cdflag         (Set checking disabled flag in query)</span><br><span class="line">                 +[no]cl             (Control display of class in records)</span><br><span class="line">                 +[no]cmd            (Control display of command line)</span><br><span class="line">                 +[no]comments       (Control display of comment lines)</span><br><span class="line">                 +[no]crypto         (Control display of cryptographic fields in records)</span><br><span class="line">                 +[no]defname        (Use search list (+[no]search))</span><br><span class="line">                 +[no]dnssec         (Request DNSSEC records)</span><br><span class="line">                 +domain=###         (Set default domainname)</span><br><span class="line">                 +[no]edns[=###]     (Set EDNS version) [0]</span><br><span class="line">                 +ednsflags=###      (Set EDNS flag bits)</span><br><span class="line">                 +[no]ednsnegotiation (Set EDNS version negotiation)</span><br><span class="line">                 +ednsopt=###[:value] (Send specified EDNS option)</span><br><span class="line">                 +noednsopt          (Clear list of +ednsopt options)</span><br><span class="line">                 +[no]expire         (Request time to expire)</span><br><span class="line">                 +[no]fail           (Don&apos;t try next server on SERVFAIL)</span><br><span class="line">                 +[no]identify       (ID responders in short answers)</span><br><span class="line">                 +[no]ignore         (Don&apos;t revert to TCP for TC responses.)</span><br><span class="line">                 +[no]keepopen       (Keep the TCP socket open between queries)</span><br><span class="line">                 +[no]multiline      (Print records in an expanded format)</span><br><span class="line">                 +ndots=###          (Set search NDOTS value)</span><br><span class="line">                 +[no]nsid           (Request Name Server ID)</span><br><span class="line">                 +[no]nssearch       (Search all authoritative nameservers)</span><br><span class="line">                 +[no]onesoa         (AXFR prints only one soa record)</span><br><span class="line">                 +[no]opcode=[###]   (Set the opcode of the request)</span><br><span class="line">                 +[no]qr             (Print question before sending)</span><br><span class="line">                 +[no]question       (Control display of question section)</span><br><span class="line">                 +[no]recurse        (Recursive mode)</span><br><span class="line">                 +retry=###          (Set number of UDP retries) [2]</span><br><span class="line">                 +[no]rrcomments     (Control display of per-record comments)</span><br><span class="line">                 +[no]search         (Set whether to use searchlist)</span><br><span class="line">                 +[no]short          (Display nothing except short</span><br><span class="line">                                      form of answer)</span><br><span class="line">                 +[no]showsearch     (Search with intermediate results)</span><br><span class="line">                 +[no]split=##       (Split hex/base64 fields into chunks)</span><br><span class="line">                 +[no]stats          (Control display of statistics)</span><br><span class="line">                 +subnet=addr        (Set edns-client-subnet option)</span><br><span class="line">                 +[no]tcp            (TCP mode (+[no]vc))</span><br><span class="line">                 +time=###           (Set query timeout) [5]</span><br><span class="line">                 +[no]trace          (Trace delegation down from root [+dnssec])</span><br><span class="line">                 +tries=###          (Set number of UDP attempts) [3]</span><br><span class="line">                 +[no]ttlid          (Control display of ttls in records)</span><br><span class="line">                 +[no]vc             (TCP mode (+[no]tcp))</span><br><span class="line">        global d-opts and servers (before host name) affect all queries.</span><br><span class="line">        local d-opts and servers (after host name) affect only that lookup.</span><br><span class="line">        -h                           (print help and exit)</span><br><span class="line">        -v                           (print version and exit)</span><br></pre></td></tr></table></figure></p><p>具体参数介绍如下，这里并不笼统翻译，仅对部分参数进行补充说明：</p><p><strong>server</strong> : 所查询的name server的域名或者ip地址。可以是IPV4或IPV6地址，如果是主机名，dig在查询之前会将其解析成域名。若没有提供<em>server</em>参数，dig会默认查询/etc/resolve.conf中的第一个地址；若指定了“<em>-4</em>“或”<em>-6</em>“参数，则仅尝试对应的地址；若无可用地址，则dig发送请求到local host。</p><p><strong>name</strong> : 要查询的域名。</p><p><strong>type</strong> : 所查询的请求类型 - ANY, A, MX, SIG等等。若没提供type参数，则默认查询A记录。</p><p>-4<br>           Use IPv4 only.</p><p>-6<br>           Use IPv6 only.</p><p>-b address[#port]<br>           Set the source IP address of the query. The address must be a valid address on one of the host’s network interfaces, or “0.0.0.0” or “::”. An optional port may be specified by appending “#<port>“</port></p><p>-c class<br>           Set the query class. The default class is IN; other classes are HS for Hesiod records or CH for Chaosnet records. 域名所关联到的资料会放在资源记录(Resource Records, RR)中，这些记录被分成几种类别（class），不同类别的RR，分别记录相关的网络形态或软件，目前的类别有：internet(任何以TCP/IP为基础的internet架构)，以Chaosnet协议为基础的网络，以及使用Hesiod软件的网络（Chaosnet是一种古董级的网络）。</p><p>-f file<br>           Batch mode: dig reads a list of lookup requests to process from the given file. Each line in the file should be organized in the same way they would be presented as queries to dig using the command-line interface.</p><p>-i<br>           Do reverse IPv6 lookups using the obsolete RFC1886 IP6.INT domain, which is no longer in use. Obsolete bit string label queries (RFC2874) are not attempted.</p><p>-k keyfile<br>           Sign queries using TSIG using a key read from the given file. Key files can be generated using tsig-keygen(8). When using TSIG authentication with dig, the name server that is queried needs to know the key and algorithm that is being used. In BIND, this is done by providing appropriate key and server statements in named.conf.<br>           TSIG提供DNS server在做Zone Transfer及DNS更新(更新zone的设定…)时对其传输资料所做的加密，并对其他DNS Server做认证； ”rndc” command使得使用者能远程管控DNS server，并对传输资料作加密， 以提高DNS server的安全防护。Transaction Signature(TSIG ; RFC 2845)是使用加密签名验证DNS信息，特別是回应与更新。TSIG以MD5 hash加密签名(cryptographic signature)方式，认证DNS server间的资料传输。</p><p>-m<br>           Enable memory usage debugging.</p><p>-p port<br>           Send the query to a non-standard port on the server, instead of the defaut port 53. This option would be used to test a name server that has been configured to listen for queries on a non-standard port number.</p><p>-q name<br>           The domain name to query. This is useful to distinguish the name from other arguments.</p><p>-t type<br>           The resource record type to query. It can be any valid query type which is supported in BIND 9. The default query type is “A”, unless the -x option is supplied to indicate a reverse lookup. A zone transfer can be requested by specifying a type of AXFR. When an incremental zone transfer (IXFR) is required, set the type to ixfr=N. The incremental zone transfer will contain the changes made to the zone since the serial number in the zone’s SOA record was N.</p><p>-v<br>           Print the version number and exit.</p><p>-x addr<br>           Simplified <strong>reverse lookups</strong>, for mapping addresses to names. The addr is an IPv4 address in dotted-decimal notation, or a colon-delimited IPv6 address. When the -x is used, there is no need to provide the name, class and type arguments.  dig automatically performs a lookup for a name like 94.2.0.192.in-addr.arpa and sets the query type and class to PTR and IN respectively. IPv6 addresses are looked up using nibble format under the IP6.ARPA domain (but see also the -i option).</p><p>-y [hmac:]keyname:secret<br>           Sign queries using TSIG with the given authentication key.  keyname is the name of the key, and secret is the base64 encoded shared secret.  hmac is the name of the key algorithm; valid choices are hmac-md5, hmac-sha1, hmac-sha224, hmac-sha256, hmac-sha384, or hmac-sha512. If hmac is not specified, the default is hmac-md5.<br>           NOTE: You should use the -k option and avoid the -y option, because with -y the shared secret is supplied as a command line argument in clear text. This may be visible in the output from ps(1) or in a history file maintained by the user’s shell.</p><p>另外，dig还提供了一些其他选项（flag），用于影响查询的方式和结果的呈现方式。<br>flag以 <strong>+keyword=value </strong> 的形式使用。具体的flag如下：</p><p> +[no]aaonly<br>           Sets the “aa” flag in the query. <strong><em>Authoritative Answer.</em></strong></p><p>+[no]additional<br>           Display [do not display] the additional section of a reply. The default is to display it.</p><p>+[no]adflag<br>           Set [do not set] the AD (authentic data) bit in the query. This requests the server to return whether all of the answer and authority sections have all been validated as secure according to the security policy of the server. AD=1 indicates that all records have been validated as secure and the answer is not from a OPT-OUT range. AD=0 indicate that some part of the answer was insecure or not validated. This bit is set by default.</p><p>+[no]all<br>           Set or clear all display flags.</p><p>+[no]answer<br>           Display [do not display] the answer section of a reply. The default is to display it.</p><p>+[no]authority<br>           Display [do not display] the authority section of a reply. The default is to display it.</p><p>+[no]besteffort<br>           Attempt to display the contents of messages which are malformed. The default is to not display malformed answers.</p><p>+bufsize=B<br>           Set the UDP message buffer size advertised using EDNS0 to B bytes. The maximum and minimum sizes of this buffer are 65535 and 0 respectively. Values outside this range are rounded up or down appropriately. Values other than zero will cause a EDNS query to be sent.</p><p>+[no]cdflag<br>           Set [do not set] the CD (checking disabled) bit in the query. This requests the server to not perform DNSSEC validation of responses.</p><p>+[no]class<br>           Display [do not display] the CLASS when printing the record.</p><p>+[no]cmd<br>           Toggles the printing of the initial comment in the output identifying the version of dig and the query options that have been applied. This comment is printed by default.</p><p>+[no]comments<br>           Toggle the display of comment lines in the output. The default is to print comments.</p><p>+[no]crypto<br>           Toggle the display of cryptographic fields in DNSSEC records. The contents of these field are unnecessary to debug most DNSSEC validation failures and removing them makes it easier to see the common failures. The default is to display the fields. When omitted they are replaced by the string “[omitted]” or in the DNSKEY case the key id is displayed as the replacement, e.g. “[ key id = value]”.</p><p>+[no]defname<br>           Deprecated, treated as a synonym for +[no]search</p><p>+[no]dnssec<br>           Requests DNSSEC records be sent by setting the DNSSEC OK bit (DO) in the OPT record in the additional section of the query.</p><p>+domain=somename<br>           Set the search list to contain the single domain somename, as if specified in a domain directive in /etc/resolv.conf, and enable search list processing as if the +search option were given.<br>+[no]edns[=#]<br>           Specify the EDNS version to query with. Valid values are 0 to 255. Setting the EDNS version will cause a EDNS query to be sent.  +noedns clears the remembered EDNS version. EDNS is set to 0 by default.</p><p>+[no]ednsflags[=#]<br>           Set the must-be-zero EDNS flags bits (Z bits) to the specified value. Decimal, hex and octal encodings are accepted. Setting a named flag (e.g. DO) will silently be ignored. By default, no Z bits are set.</p><p>+[no]ednsnegotiation<br>           Enable / disable EDNS version negotiation. By default EDNS version negotiation is enabled.</p><p>+[no]ednsopt[=code[:value]]<br>           Specify EDNS option with code point code and optionally payload of value as a hexadecimal string. +noednsopt clears the EDNS options to to be sent.</p><p>+[no]expire<br>           Send an EDNS Expire option.</p><p>+[no]fail<br>           Do not try the next server if you receive a SERVFAIL. The default is to not try the next server which is the reverse of normal stub resolver behavior.</p><p>+[no]identify<br>           Show [or do not show] the IP address and port number that supplied the answer when the +short option is enabled. If short form answers are requested, the default is not to show the source address and port number of the server that provided the answer.</p><p>+[no]ignore<br>           Ignore truncation in UDP responses instead of retrying with TCP. By default, TCP retries are performed.</p><p>+[no]keepopen<br>           Keep the TCP socket open between queries and reuse it rather than creating a new TCP socket for each lookup. The default is +nokeepopen.</p><p>+[no]multiline<br>           Print records like the SOA records in a verbose multi-line format with human-readable comments. The default is to print each record on a single line, to facilitate machine parsing of the dig output.</p><p>+ndots=D<br>           Set the number of dots that have to appear in name to D for it to be considered absolute. The default value is that defined using the ndots statement in /etc/resolv.conf, or 1 if no ndots statement is present. Names with fewer dots are interpreted as relative names and will be searched for in the domains listed in the search or domain directive in /etc/resolv.conf if +search is set.</p><p>+[no]nsid<br>           Include an EDNS name server ID request when sending a query.</p><p>+[no]nssearch<br>           When this option is set, dig attempts to find the authoritative name servers for the zone containing the name being looked up and display the SOA record that each name server has for the zone.</p><p>+[no]onesoa<br>           Print only one (starting) SOA record when performing an AXFR. The default is to print both the starting and ending SOA records.</p><p>+[no]opcode=value<br>           Set [restore] the DNS message opcode to the specified value. The default value is QUERY (0).</p><p>+[no]qr<br>           Print [do not print] the query as it is sent. By default, the query is not printed.</p><p>+[no]question<br>           Print [do not print] the question section of a query when an answer is returned. The default is to print the question section as a comment.<br>+[no]rdflag<br>           A synonym for +[no]recurse.</p><p>+[no]recurse<br>           Toggle the setting of the RD (recursion desired) bit in the query. This bit is set by default, which means dig normally sends recursive queries. Recursion is automatically disabled when the +nssearch or +trace query options are used.</p><p>+retry=T<br>           Sets the number of times to retry UDP queries to server to T instead of the default, 2. Unlike +tries, this does not include the initial query.</p><p>+[no]rrcomments<br>           Toggle the display of per-record comments in the output (for example, human-readable key information about DNSKEY records). The default is not to print record comments unless multiline mode is active.</p><p>+[no]search<br>           Use [do not use] the search list defined by the searchlist or domain directive in resolv.conf (if any).The search list is not used by default.<br>           ´ndots’ from resolv.conf (default 1) which may be overridden by +ndots determines if the name will be<br>           treated as relative or not and hence whether a search is eventually performed or not.</p><p>+[no]short<br>           Provide a terse answer. The default is to print the answer in a verbose form.</p><p>+[no]showsearch<br>           Perform [do not perform] a search showing intermediate results.</p><p>+[no]sigchase<br>           Chase DNSSEC signature chains. Requires dig be compiled with -DDIG_SIGCHASE.</p><p>+[no]sit[=####]<br>           Send a Source Identity Token EDNS option, with optional value. Replaying a SIT from a previous response will allow the server to identify a previous client. The default is +nosit. Currently using experimental value 65001 for the option code.</p><p>+split=W<br>           Split long hex- or base64-formatted fields in resource records into chunks of W characters (where W is rounded up to the nearest multiple of 4).  +nosplit or +split=0 causes fields not to be split at all. The default is 56 characters, or 44 characters when multiline mode is active.</p><p>+[no]stats<br>           This query option toggles the printing of statistics: when the query was made, the size of the reply and so on. The default behavior is to print the query statistics.</p><p>+[no]subnet=addr/prefix<br>           Send an EDNS Client Subnet option with the specified IP address or network prefix.</p><p>+[no]tcp<br>           Use [do not use] TCP when querying name servers. The default behavior is to use UDP unless an ixfr=N query is requested, in which case the default is TCP. AXFR queries always use TCP.</p><p>+time=T<br>           Sets the timeout for a query to T seconds. The default timeout is 5 seconds. An attempt to set T to less than 1 will result in a query timeout of 1 second being applied.</p><p>+[no]topdown<br>           When chasing DNSSEC signature chains perform a top-down validation. Requires dig be compiled with -DDIG_SIGCHASE.<br>+[no]rdflag<br>           A synonym for +[no]recurse.</p><p>+[no]recurse<br>           Toggle the setting of the RD (recursion desired) bit in the query. This bit is set by default, which<br>           means dig normally sends recursive queries. Recursion is automatically disabled when the +nssearch or<br>           +trace query options are used.</p><p>+retry=T<br>           Sets the number of times to retry UDP queries to server to T instead of the default, 2. Unlike +tries,<br>           this does not include the initial query.</p><p>+[no]rrcomments<br>           Toggle the display of per-record comments in the output (for example, human-readable key information<br>           about DNSKEY records). The default is not to print record comments unless multiline mode is active.</p><p>+[no]search<br>           Use [do not use] the search list defined by the searchlist or domain directive in resolv.conf (if any).<br>           The search list is not used by default.<br>           ´ndots’ from resolv.conf (default 1) which may be overridden by +ndots determines if the name will be<br>           treated as relative or not and hence whether a search is eventually performed or not.</p><p>+[no]short<br>           Provide a terse answer. The default is to print the answer in a verbose form.</p><p>+[no]showsearch<br>           Perform [do not perform] a search showing intermediate results.</p><p>+[no]sigchase<br>           Chase DNSSEC signature chains. Requires dig be compiled with -DDIG_SIGCHASE.</p><p>+[no]sit[=####]<br>           Send a Source Identity Token EDNS option, with optional value. Replaying a SIT from a previous response<br>           will allow the server to identify a previous client. The default is +nosit. Currently using<br>           experimental value 65001 for the option code.</p><p>+split=W<br>           Split long hex- or base64-formatted fields in resource records into chunks of W characters (where W is<br>           rounded up to the nearest multiple of 4).  +nosplit or +split=0 causes fields not to be split at all.<br>           The default is 56 characters, or 44 characters when multiline mode is active.</p><p>+[no]stats<br>           This query option toggles the printing of statistics: when the query was made, the size of the reply<br>           and so on. The default behavior is to print the query statistics.</p><p>+[no]subnet=addr/prefix<br>           Send an EDNS Client Subnet option with the specified IP address or network prefix.</p><p>+[no]tcp<br>           Use [do not use] TCP when querying name servers. The default behavior is to use UDP unless an ixfr=N<br>           query is requested, in which case the default is TCP. AXFR queries always use TCP.</p><p>+time=T<br>           Sets the timeout for a query to T seconds. The default timeout is 5 seconds. An attempt to set T to<br>           less than 1 will result in a query timeout of 1 second being applied.</p><p>+[no]topdown<br>           When chasing DNSSEC signature chains perform a top-down validation. Requires dig be compiled with<br>           -DDIG_SIGCHASE.<br>+[no]rdflag<br>           A synonym for +[no]recurse.</p><p>+[no]recurse<br>           Toggle the setting of the RD (recursion desired) bit in the query. This bit is set by default, which<br>           means dig normally sends recursive queries. Recursion is automatically disabled when the +nssearch or<br>           +trace query options are used.</p><p>+retry=T<br>           Sets the number of times to retry UDP queries to server to T instead of the default, 2. Unlike +tries,<br>           this does not include the initial query.</p><p>+[no]rrcomments<br>           Toggle the display of per-record comments in the output (for example, human-readable key information<br>           about DNSKEY records). The default is not to print record comments unless multiline mode is active.</p><p>+[no]search<br>           Use [do not use] the search list defined by the searchlist or domain directive in resolv.conf (if any).<br>           The search list is not used by default.<br>           ´ndots’ from resolv.conf (default 1) which may be overridden by +ndots determines if the name will be<br>           treated as relative or not and hence whether a search is eventually performed or not.</p><p>+[no]short<br>           Provide a terse answer. The default is to print the answer in a verbose form.</p><p>+[no]showsearch<br>           Perform [do not perform] a search showing intermediate results.</p><p>+[no]sigchase<br>           Chase DNSSEC signature chains. Requires dig be compiled with -DDIG_SIGCHASE.</p><p>+[no]sit[=####]<br>           Send a Source Identity Token EDNS option, with optional value. Replaying a SIT from a previous response<br>           will allow the server to identify a previous client. The default is +nosit. Currently using<br>           experimental value 65001 for the option code.</p><p>+split=W<br>           Split long hex- or base64-formatted fields in resource records into chunks of W characters (where W is<br>           rounded up to the nearest multiple of 4).  +nosplit or +split=0 causes fields not to be split at all.<br>           The default is 56 characters, or 44 characters when multiline mode is active.</p><p>+[no]stats<br>           This query option toggles the printing of statistics: when the query was made, the size of the reply<br>           and so on. The default behavior is to print the query statistics.</p><p>+[no]subnet=addr/prefix<br>           Send an EDNS Client Subnet option with the specified IP address or network prefix.</p><p>+[no]tcp<br>           Use [do not use] TCP when querying name servers. The default behavior is to use UDP unless an ixfr=N<br>           query is requested, in which case the default is TCP. AXFR queries always use TCP.</p><p>+time=T<br>           Sets the timeout for a query to T seconds. The default timeout is 5 seconds. An attempt to set T to<br>           less than 1 will result in a query timeout of 1 second being applied.</p><p>+[no]topdown<br>           When chasing DNSSEC signature chains perform a top-down validation. Requires dig be compiled with -DDIG_SIGCHASE.<br> +[no]trace<br>           Toggle tracing of the delegation path from the root name servers for the name being looked up. Tracing is disabled by default. When tracing is enabled, dig makes iterative queries to resolve the name being looked up. It will follow referrals from the root servers, showing the answer from each server that was<br>           used to resolve the lookup.<br>           If @server is also specified, it affects only the initial query for the root zone name servers.<br>           +dnssec is also set when +trace is set to better emulate the default queries from a nameserver.</p><p>+tries=T<br>           Sets the number of times to try UDP queries to server to T instead of the default, 3. If T is less than or equal to zero, the number of tries is silently rounded up to 1.</p><p>+trusted-key=####<br>           Specifies a file containing trusted keys to be used with +sigchase. Each DNSKEY record must be on its own line.<br>           If not specified, dig will look for /etc/trusted-key.key then trusted-key.key in the current directory.<br>           Requires dig be compiled with -DDIG_SIGCHASE.</p><p>+[no]ttlid<br>           Display [do not display] the TTL when printing the record.</p><p>+[no]vc<br>           Use [do not use] TCP when querying name servers. This alternate syntax to +[no]tcp is provided for<br>           backwards compatibility. The “vc” stands for “virtual circuit”.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Dig, domain information groper，是一款专门用于进行DNS查询的工具。 Dig以其灵活性，易用性，以及简明的输出得到了大多数DNS管理员的青睐。Dig支持命令行模式和批处理模式，批处理模式下，dig可以从文件中读取请求并批量处理。话不多说，进入正
      
    
    </summary>
    
    
      <category term="DNS" scheme="http://franklea.github.io/tags/DNS/"/>
    
      <category term="dig" scheme="http://franklea.github.io/tags/dig/"/>
    
  </entry>
  
  <entry>
    <title>LLVM编译器框架浅析</title>
    <link href="http://franklea.github.io/2018/04/10/llvm-clang/"/>
    <id>http://franklea.github.io/2018/04/10/llvm-clang/</id>
    <published>2018-04-10T01:08:17.000Z</published>
    <updated>2018-04-11T08:52:08.485Z</updated>
    
    <content type="html"><![CDATA[<p>很早就开始接触和使用LLVM，而且垂涎其丰富的工具和扩展功能已久，但一直处于现学现用的阶段，对LLVM的理解也一直是雾里看花。<br>最近正好需要再次用到LLVM，借此机会把LLVM系统的看一看。本文力求从原理和结构上对LLVM有一个基本概述，不求深挖，但求基础全面。</p><h2 id="1-什么是LLVM"><a href="#1-什么是LLVM" class="headerlink" title="1, 什么是LLVM"></a>1, 什么是LLVM</h2><p>LLVM从字面上来说是Low-level Virtual Machine，即底层的虚拟机，光从字面上来说看，仍然是一脸懵逼，不知其所以然。</p><p>官方介绍定义比较准确：A collection of modular and reusable tools to support both static and dynamic compilation of arbitrary programming languages. 理解一下，主要包含了这几层意思：</p><ul><li>1，当然，是编译器（或者编译框架）</li><li>2，包含了一个模块化、可重用的工具集；</li><li>3，支持静态和动态编译；</li><li>4，跨语言。</li></ul><p>总之，LLVM是一套很强大的编译系统。</p><p>此外，LLVM提供了许多工业级的工具和库，包含了许多子项目，其中最有名的当属Clang。LLVM在工业界也得到了广泛的使用，包括Adobe, Apple, Intel, NVIDIA……等等等等。</p><p>总结一下，LLVM具有使用简单（相对而言）， 快速，模块化等诸多有点，it is cool!</p><h2 id="2-LLVM-编译系统"><a href="#2-LLVM-编译系统" class="headerlink" title="2, LLVM 编译系统"></a>2, LLVM 编译系统</h2><p>LLVM编译系统可分为编译器基础组件和编译器框架两部分。</p><p>LLVM编译器基础组件为构建编译器提供了可重用的组件，使得构建一个新的编译器的时间开销更小，也为LLVM编译器提供了更多的功能和更好的扩展性。<br>LLVM编译器框架提供了一种编译器框架，通过框架将LLVM编译系统中的基础组件进行组合连接，进而形成具备特定属性、满足特定需求的编译器。框架包含前端、中端和后端三个部分。简单地说，前端将目标语言翻译成LLVM中间语言（LLVM IR），中端基于LLVM IR对程序进行优化分析等，后端将LLVM IR翻译成目标架构的机器指令。整理LLVM编译系统的整体内容如下：</p><ul><li>前端：<ul><li>Clang(C/C++/ObjC/OpenCL/OpenMP), flang(Fortran), LDC(D), PGI’s Fortran, etc.</li></ul></li><li>前端插件:<ul><li>Static analyser, clang-tidy, clang-format, clang-complete, etc.</li></ul></li><li>中端:<ul><li>Optimiztion and Analysis passes, integration with Polly, etc.</li></ul></li><li>后端<ul><li>JIT(MC and ORC), targets: ARM, AArch64, MIPS, PPC, x86, GPUs, BPF, WebAsm, etc.</li></ul></li><li>库<ul><li>Compiler-RT, libc++/abi, libunwind, OpenMP, libCL, etc.</li></ul></li><li>工具<ul><li>LLD, LLDB, LNT, readobj, llc, lli, bugpoint, objdump, lto, etc.</li></ul></li></ul><p>下表对LLVM和GNU编译器进行了对比。</p><table><thead><tr><th></th><th>LLVM</th><th>GNU</th></tr></thead><tbody><tr><td>Front-end</td><td>Clang</td><td>CC1/CPP</td></tr><tr><td>Middle-end</td><td>LLVM</td><td>GCC</td></tr><tr><td>Back-end</td><td>LLVM</td><td>GCC</td></tr><tr><td>Assembler</td><td>LLVM(MC)</td><td>GAS</td></tr><tr><td>Linker</td><td>LLD</td><td>GNU-LD</td></tr><tr><td>Libraries</td><td>Compiler-RT, libc++(no libc)</td><td>libgcc, stdlibc++, glibc</td></tr><tr><td>Debugger</td><td>LLDB/LLDBserver</td><td>GDB/GDBserver</td></tr></tbody></table><h3 id="2-1-三个主要的LLVM组件"><a href="#2-1-三个主要的LLVM组件" class="headerlink" title="2.1 三个主要的LLVM组件"></a>2.1 三个主要的LLVM组件</h3><p>首先简单介绍一下LLVM中三个重要的组件，包括：</p><ul><li>LLVM虚拟指令集合<ul><li>具备语言通用性，且目标无关的IR；</li><li>提供了内部IR和固定的外部表示；</li><li>为表示和修改程序提供了一种通用的方式。</li></ul></li><li>一批良好集成的库<ul><li>分析，优化，代码生成，JIT，垃圾回收机制，profiling等等；</li><li>无需自己造轮子。</li></ul></li><li>一批基于库构建的工具<ul><li>汇编器，自动调试器，链接器，代码生成，编译程序驱动器，模块优化等等；</li><li>与正常的编译过程相结合。</li></ul></li></ul><h3 id="2-2-前端"><a href="#2-2-前端" class="headerlink" title="2.2 前端"></a>2.2 前端</h3><p>和所有编译器前端类似，LLVM编译器前端对目标源代码进行解析，最终生成LLVM IR.</p><p> <img src="/images/llvm-front-end.svg" alt=""></p><h3 id="2-3-中端"><a href="#2-3-中端" class="headerlink" title="2.3 中端"></a>2.3 中端</h3><p>中端接着前端的工作，在IR的基础上对程序进行转换和优化，如下图。</p><p><img src="/images/llvm-midend.svg" alt=""></p><p>要理解中端的优化过程，理解Pass非常重要。<br>如LLVM官网所述：</p><blockquote><p>The LLVM Pass Framework is an important part of the LLVM system, because LLVM passes are where most of the interesting parts of the compiler exist. Passes perform the transformations and optimizations that make up the compiler, they build the analysis results that are used by these transformations, and they are, above all, a structuring technique for compiler code.</p></blockquote><p>关于如何写一个Pass，LLVM官网提供了非常详细的<a href="https://llvm.org/docs/WritingAnLLVMPass.html" target="_blank" rel="noopener">参考文档</a>。</p><p>LLVM编译系统中对程序的优化分为多个步骤——也可说多个Pass——进行。每个Pass中对IR进行变换和优化，多个Pass组合完成编译器进行的所有优化行为。如上图所示，多个Pass阶段共同完成了中端的分析和优化。</p><h3 id="2-4-后端"><a href="#2-4-后端" class="headerlink" title="2.4 后端"></a>2.4 后端</h3><p>后端将中端转换和优化后的IR翻译成目标架构的汇编语言。转换的过程如下图所示：</p><p><img src="/images/llvm-backend.svg" alt=""></p><ul><li>首先，将LLVM IR表示成一个有向无环图（SelectionDAG），图的节点是类<strong>SDNode</strong>的实例，包含了一条目标指令，每个<strong>SDNode</strong>有一个opcode，operands, type requirements，以及operation properties；</li><li>接着，在DAG表示上，对指令进行操作。 <em>Instruction selection pass</em>被用于将non-native的DAG转换成native的目标特定指令。包括：<ul><li>Combining;</li><li>Legalizing，将DAG变换为使用本地支持的类型和操作;</li><li>Scheduling;</li><li>Register Allocation</li></ul></li><li>最后，生成目标汇编指令。</li></ul><p>SelectionDAG: 选择有向无环图。指令选择（也成为代码选择，或代码生成），是编译器代码生成器后端所涉及的重要问题之一。另外两个重要问题是指令调度与寄存器分配。指令选择器负责通过尽可能的用好可用的机器指令，将程序从目标机器无关的表示翻译到目标机器特定的形式。</p><blockquote><p>LLVM uses a SelectionDAG to represent LLVM IR instructions, and nodes of the SelectionDAG ideally represent native target instructions. During code generation, instruction selection passes are performed to convert non-native DAG instructions into native target-specific instructions. The pass described in XXXISelDAGToDAG.cpp is used to match patterns and perform DAG-to-DAG instruction selection. Optionally, a pass may be defined (in XXXBranchSelector.cpp) to perform similar DAG-to-DAG operations for branch instructions. Later, the code in XXXISelLowering.cpp replaces or removes operations and data types not supported natively (legalizes) in a SelectionDAG.</p></blockquote><p>LLVM同样提供了如何编写一个LLVM后端的<a href="https://llvm.org/docs/WritingAnLLVMBackend.html" target="_blank" rel="noopener">参考文档</a>。<br>这里仅列出基本的步骤，用于对整个过程有一个大概的了解，如下：</p><ul><li>创建类<strong>TargetMachine</strong>的自雷，用于描述目标机器的特征；</li><li>定义目标寄存器集合。使用TableGen，根据目标特定的RegisterInfo.td文件生成寄存器定义、寄存器依赖、寄存器类型的代码。编写<strong>TargetRegisterInfo</strong>的子类；</li><li>定义LLVM IR从指令的DAG表示到本地目标指令的选择和变换；</li><li>编写一个将LLVM IR转换成目标机器GAS (GNU Assembler)格式的assembly printer（用于生成汇编指令输出文件）；</li><li>可选地，为子目标（如，具有不同能力的版本）增加支持；</li><li>可选地，增加JIT支持，创建一个机器代码emitter (TargetJITInfo的子类)，用于直接在内存中生成二进制代码。</li></ul><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文比较highlevel的对LLVM框架进行了一个简单分析，许多重要概念还需结合官方文档来深入理解，这里不再详细呈现。与常规的编译器相比，LLVM提供了更具通用性和扩展性的编译器框架，同时，丰富的库和工具为程序分析提供了丰富而强大的功能。万变不离其宗。要理解LLVM，还是要从编译器的工作原理出发，在结合LLVM具体的实现来尝试理解。</p><p>纸上得来终觉浅，后面有时间再整理一下LLVM实践相关的内容。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;很早就开始接触和使用LLVM，而且垂涎其丰富的工具和扩展功能已久，但一直处于现学现用的阶段，对LLVM的理解也一直是雾里看花。&lt;br&gt;最近正好需要再次用到LLVM，借此机会把LLVM系统的看一看。本文力求从原理和结构上对LLVM有一个基本概述，不求深挖，但求基础全面。&lt;/p
      
    
    </summary>
    
    
      <category term="llvm" scheme="http://franklea.github.io/tags/llvm/"/>
    
      <category term="compiler" scheme="http://franklea.github.io/tags/compiler/"/>
    
  </entry>
  
</feed>
